#!/bin/bash

usage() {
    echo "Usage: `basename $0` [start VHOST_DIR | restart | reload | stop | status]" 1>&2
    exit 1
}

# verify usage: "start" requires another param, all others require 1
if ([ "$1" == "start" ] && [ $# -ne 2 ]) || ([ "$1" != "start" ] && [ $# -ne 1 ]); then
    usage
fi

# only run as ubuntu
if [ "$(whoami)" != "ubuntu" ]; then
    echo "This script must only be run by the ubuntu user (don't use sudo)!"
    exit 1
fi

start() {
    if [ $(service apache2 status >/dev/null)$? == 0 ]; then
        echo "Apache is already running; did you mean \``basename $0` restart\`?" 1>&2
        exit 2
    fi

    # ensure the param is a directory, expand it if so
    if  [ ! -d "$1" ]; then
        usage
    fi
    vhost=$(readlink -f "$1")

    # disable prior cs50 configuration, if available
    sudo a2disconf cs50 >/dev/null 2>&1

    # copy template over
    sudo cp /etc/apache2/conf-available/cs50-template.conf /etc/apache2/conf-available/cs50.conf

    # update vhost dir in conf
    sudo sed -i "s#/home/ubuntu/workspace/vhosts#$vhost#g" /etc/apache2/conf-available/cs50.conf

    # configure apache for online or offline
    if [ -z ${IDE_OFFLINE+x} ]; then
        # online IDE, externally served via proxy at C9_HOSTNAME over https
        domain="https://$(hostname50)"
    else
        # offline IDE, use hostname over http
        domain="http://$(hostname50)"
    fi
    sudo sed -i "s-ServerName.*\$-ServerName ${domain}-" /etc/apache2/conf-available/cs50.conf

    # enable and start
    sudo a2enconf cs50 >/dev/null 2>&1

    service apache2 start

    if [ $? -eq 0 ]; then
        echo "Apache started successfully!"
        echo "Your site is now available at ${domain}"
    else
        echo "Apache was not started successfully."
        exit 3
    fi
}

case "$1" in
    start)
        start $2
    ;;
    stop)
        if [ $(service apache2 status >/dev/null)$? != 0 ]; then
            echo "Apache is not running!"
            exit 2
        fi

        service apache2 stop

        if [ $? -eq 0 ]; then
            echo "Apache stopped successfully."
        else
            echo "Apache failed to stop!"
            exit 2
        fi
    ;;
    reload)
        service apache2 reload
    ;;
    restart)
        service apache2 restart
    ;;
    status)
        service apache2 status
    ;;
    *)
        usage
    ;;
esac

exit 0